{% extends "base.html" %}
{% load static %}

{% block title %}Статистика продаж{% endblock %}

{% block content %}
<h1>Статистика продаж</h1>
<p>Ваша тайм-зона: {{ user_timezone }}</p>
{% if user.is_authenticated and user.is_superuser %}
<div>
    <div>
        <div>
            Заказчики по городам
        </div>
        <div>
            {% regroup clients_by_city by city as city_list %}
            <ul>
                {% for city in city_list %}
                <li>
                    <strong>{{ city.grouper }}:</strong>
                    <ul>
                        {% for client in city.list %}
                        <li>{{ client.company_name }}</li>
                        {% endfor %}
                    </ul>
                </li>
                {% empty %}
                <li>Нет данных</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div>
        <div>
            Самая популярная игрушка
        </div>
        <div>
            <p><strong>{{ most_popular.name|default:'Нет данных' }}</strong></p>
        </div>
    </div>
    <div>
        <div>
            Наименее популярная игрушка
        </div>
        <div>
            <p><strong>{{ least_popular.name|default:'Нет данных' }}</strong></p>
        </div>
    </div>
    <div>
        <div>
            Ежемесячный объем продаж
        </div>
        <img src="{{ chart_images.monthly_sales }}">
    </div>
    <div>
        <div>
            Годовой отчет поступлений
        </div>
        <img src="{{ chart_images.yearly_income }}">
    </div>
    <div>
        <div>
            Тренд продаж (по месяцам)
        </div>
        {% if sales_trend and sales_trend|length > 0 %}
        <div>
            <table>
                <thead>
                    <tr>
                        <th>Месяц</th>
                        <th>Сумма продаж</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month, total in sales_trend %}
                    <tr>
                        <td>{{ month|date:'Y-m' }}</td>
                        <td>{{ total|default:0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div>Нет данных для отображения тренда продаж.</div>
        {% endif %}
    </div>
</div>
{% else %}
<div>
    Доступ к статистике ограничен.
</div>
{% endif %}
{% endblock %}